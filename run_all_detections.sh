#!/bin/bash

# ===================================================================================
#      æ‰¹é‡ç”Ÿæˆ lines.json - V3 (ä½¿ç”¨ LSD + é•¿åº¦æ»¤æ³¢)
# ===================================================================================
#
# ç›®çš„: ä½¿ç”¨æ›´é²æ£’çš„ LSD ç®—æ³•ä¸ºæ‰€æœ‰åœºæ™¯é‡æ–°ç”Ÿæˆ lines.jsonï¼Œ
#       å¹¶é€šè¿‡é•¿åº¦åå¤„ç†æ»¤æ³¢ï¼Œç§»é™¤ç”±çº¹ç†äº§ç”Ÿçš„è¿‡çŸ­ç›´çº¿ã€‚
#
# ===================================================================================

# --- [ 1. é…ç½®åŒº ] ---
PROJECT_DIR=$(pwd)
DATA_ROOT_DIR="$PROJECT_DIR/data"
# ç¡®ä¿è¿™ä¸ªè„šæœ¬èƒ½æ‰¾åˆ°æˆ‘ä»¬æœ€æ–°çš„ detect_lines.py (V5)
DETECT_SCRIPT="$PROJECT_DIR/detect_lines.py"

# åœ¨è¿™é‡Œåˆ—å‡ºæ‚¨å¸Œæœ›å¤„ç†çš„æ‰€æœ‰ ETH3D åœºæ™¯æ–‡ä»¶å¤¹åç§°
SCENE_NAMES=(
    "courtyard"
    "delivery_area"
    "electro"
    "facade"
    "kicker"
    "meadow"
    "office"
    "pipes"
    "playground"
    "relief"
    "relief_2"
)

# --- [ æ ¸å¿ƒå‚æ•°åŒº ] ---
#
#   è¿™æ˜¯åå¤„ç†æ»¤æ³¢çš„æœ€å°é•¿åº¦é˜ˆå€¼ï¼ˆå•ä½ï¼šåƒç´ ï¼‰ã€‚
#   æ‰€æœ‰æ£€æµ‹å‡ºçš„ã€é•¿åº¦å°äºæ­¤å€¼çš„ç›´çº¿éƒ½å°†è¢«ä¸¢å¼ƒã€‚
#   40 æ˜¯ä¸€ä¸ªæ¯”è¾ƒåˆç†ã€é€šç”¨çš„èµ·å§‹å€¼ã€‚
MIN_FILTER_LENGTH=60

set -e # é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢

# --- [ 2. æ‰§è¡ŒåŒº ] ---

echo "ğŸš€ å¼€å§‹ä½¿ç”¨ LSD + é•¿åº¦æ»¤æ³¢(min_len=${MIN_FILTER_LENGTH}) ä¸ºæ‰€æœ‰åœºæ™¯æ‰¹é‡ç”Ÿæˆ lines.json æ–‡ä»¶..."
cd "$PROJECT_DIR"

for scene in "${SCENE_NAMES[@]}"; do
    scene_path="$DATA_ROOT_DIR/$scene"

    if [ ! -d "$scene_path" ]; then
        echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°åœºæ™¯ç›®å½• '$scene_path'ï¼Œè·³è¿‡æ­¤åœºæ™¯ã€‚"
        continue
    fi
    
    # ä¸ºäº†ç¡®ä¿ä½¿ç”¨æ–°å‚æ•°é‡æ–°ç”Ÿæˆï¼Œæˆ‘ä»¬å…ˆåˆ é™¤æ—§æ–‡ä»¶
    if [ -f "$scene_path/lines.json" ]; then
        echo "â„¹ï¸ [${scene}] çš„æ—§ lines.json å·²å­˜åœ¨ï¼Œå°†åˆ é™¤ä»¥ä½¿ç”¨æ–°å‚æ•°é‡æ–°ç”Ÿæˆã€‚"
        rm "$scene_path/lines.json"
    fi
    if [ -d "$scene_path/lines_visualization" ]; then
        rm -r "$scene_path/lines_visualization"
    fi

    echo
    echo "--- æ­£åœ¨å¤„ç†åœºæ™¯: [${scene}] ---"

    # è°ƒç”¨è„šæœ¬ï¼Œå¹¶æ˜ç¡®æŒ‡å®šä½¿ç”¨ lsd æ£€æµ‹å™¨ å’Œ æ–°çš„é•¿åº¦æ»¤æ³¢å‚æ•°
    python "$DETECT_SCRIPT" \
        --dataset_path "$scene_path" \
        --detector "lsd" \
        --min_filter_length "$MIN_FILTER_LENGTH" \
        --visualize
done

echo
echo "# ======================================================================"
echo "# ğŸ‰ğŸ‰ğŸ‰ å…¨éƒ¨åœºæ™¯çš„ lines.json ä½¿ç”¨ LSD+æ»¤æ³¢ é‡æ–°ç”Ÿæˆå®Œæ¯•ï¼ ğŸ‰ğŸ‰ğŸ‰"
echo "# ======================================================================"
echo "è¯·åŠ¡å¿…æ£€æŸ¥æ¯ä¸ªåœºæ™¯ä¸‹çš„ 'lines_visualization' æ–‡ä»¶å¤¹ï¼Œç¡®è®¤æ»¤æ³¢æ•ˆæœã€‚"